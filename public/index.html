<!DOCTYPE html>
<html lang="en" ng-app="InitApp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <script src="assets/angular.min.js"></script>
    <script src="assets/angular-route.js"></script>
    <script src="assets/swal.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBcY86zhtxk58neT-6jq4yPQkVI-rehHRQ",
            authDomain: "cftzaorg.firebaseapp.com",
            databaseURL: "https://cftzaorg.firebaseio.com",
            projectId: "cftzaorg",
            storageBucket: "cftzaorg.appspot.com",
            messagingSenderId: "1006717352105",
            appId: "1:1006717352105:web:ec874b4673de73ce"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
</head>

<body>
    <div ng-view></div>
    <script>
        (function () {
            const main = angular.module("InitApp", ["ngRoute"]);
            main.config(function ($locationProvider, $routeProvider) {
                $locationProvider.hashPrefix("");
                $routeProvider
                    .when("/", {
                        template: "<login></login>"
                    })
                    .when("/register", {
                        template: "<register></register>"
                    })
                    .when("/dashboard", {
                        template: "<dashboard></dashboard>",
                        resolve: {
                            checkUserState: function (/*Goodwish to update state of the active user*/) {
                                firebase.auth().onAuthStateChanged(function (user) {
                                    if (!user) {
                                        $location.path("/").replace();
                                    }
                                });
                            }
                        }
                    })
                    .otherwise({
                        redirectTo: "/"
                    })
            });

            
            //Registration Component
            main.component("register", {
                templateUrl: "templates/register.html",
                controller: ["ExceptionsSvc", function (ExceptionsSvc) {
                    
                }]
            });
            //Login Component
            main.component("login", {
                templateUrl: "LogIn.html",
                controller: ["LoginSvc", "ExceptionsSvc", function (LoginSvc, ExceptionsSvc) {
                    this.logoImageUrlPath = "https://cft-za.org.za/home/wp-content/uploads/2019/06/Logo-1.png";
                    this.attemptUserSignInService = function () {
                        if (this.username && this.password) {
                            LoginSvc.LoginUser(this.username, this.password);
                        } else {
                            ExceptionsSvc.InvalidUserException();
                        }
                    }
                }]
            });
            //Authentication Service
            main.service("LoginSvc", function (ExceptionsSvc, $location) {
                this.LoginUser = function (emailAccount, accountPassword) {
                    firebase.auth().signInWithEmailAndPassword(emailAccount, accountPassword)
                        .then(function () {
                            ExceptionsSvc.loginSuccessNotify();
                            //$location.path("/dashboard").replace();
                        })
                        .catch(function (error) {
                            //dynamic error response
                            swal("Login Error", error.message, "error");
                        })
                }
            })

            //Exception Handling Error Messages Service
            main.service("ExceptionsSvc", function () {
                this.InvalidUserException = function () {
                    swal("Invalid User", "Check your username and password", "error");
                }
                this.loginSuccessNotify = function () {
                    swal("Login Success", "User has been signed In succesfully", "success");
                }
            });
        })()
    </script>
</body>

</html>